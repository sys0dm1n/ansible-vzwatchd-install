---
  - hosts: Your_Server_Name
    user: root
    sudo: yes

    vars:
      dest_email_add:admin@example.com
    
    tasks:
      - name: Only if it is an OpenVZ
        stat: path=/proc/user_beancounters
        register: openvz_vm

      - name: Check if it is an OpenVZ container and OS Debian or Ubuntu
        fail: msg=" OS is not Debian/Ubuntu or OpenVZ container."
        when: openvz_vm.stat.exists == 'False' and (ansible_distribution != "Ubuntu" or ansible_distribution != "Debian")
  
      - name: Installing make package
        apt: package={{ item }} state=present update_cache=yes cache_valid_time=3600
        with_items:
          - make
          - gcc

      - name: Install vzwatchd from CPAN
        shell: PERL_MM_USE_DEFAULT=1 perl -MCPAN -e 'install App::OpenVZ::BCWatch'
 
      - name: Edit vzwatchd.conf file
        template: src=vzwatchd.conf.j2 dest=/etc/vzwatchd.conf backup=yes owner=root group=root mode=644

      - name: Configure vzwatchd to start automatically
        shell: /usr/local/bin/vzwatchd install
 
      - name: Start vzwatchd
        shell: /usr/local/bin/vzwatchd start
